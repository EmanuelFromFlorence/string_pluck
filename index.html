<!DOCTYPE html>
<html>
    <head>
        <title>comic sans</title>
        <meta charset='utf-8' />
        <!-- libs -->
        <script type='text/javascript' src='jquery.min.js'></script>
        <script type='text/javascript' src='draw.js'></script>
        <script type='text/javascript' src='notes.js'></script>
        <script type='text/javascript' src='waves.js'></script>
        <script type='text/javascript' src='drawwave.js'></script>
        <script type='text/javascript' src='sound.js'></script>

        <style>
            html, body { margin: 0; padding: 0; background: white; }
            .container { width: 600px; margin: 0 auto; padding: 50px; text-align: center; }
            #draw { width: 600px; height: 400px; border: 3px solid transparent; background: #fff; }
            #save { margin: 10px; font-size: 20px; line-height: 25px; }
        </style>
        <script type='text/javascript'>

            $(document).ready(function() {

                // create a drawing area inside an element
                var canvas_jq = new Canvas($('#draw'));

                let duration = 4000;
                let string_y = 150;
                
                var waves = [110, 220, 330, 440, 550, 660, 770, 880].map(freq => new stringSubCanvas(canvas_jq, new standingWave({freq, duration}), 110, 100, 0));

                var drawWave = new superposedStringCanvas(canvas_jq, waves, string_y*2)
                //drawWave.init()

                var canvas = canvas_jq.get(0);
                var context = canvas.getContext("2d");

                function init() {
                    context.fillStyle = "rgba(255,255,255, 0.3)";
                    context.lineWidth = 2;
                    context.strokeStyle = "#000";
                }
                init()
                let soundwave;

                let start;
                let playing = false;
                let frame = () => {
                    context.fillRect(0, 0, context.width, context.height);
                    let time_diff = Date.now()-start;
                    drawWave.draw(time_diff, 0)
                    if(playing && time_diff <= duration) {
                        requestAnimationFrame(frame)
                    } else {
                        playing = false;
                        if(soundwave) soundwave.pause();
                    }
                }

                let plucking = false;
                canvas_jq.on('mousedown', (e) => {
                    plucking = true;
                    playing = false;
                    if(soundwave) soundwave.pause();
                })
                canvas_jq.on('mouseup', (e) => {
                    if(plucking) {
                        let {offsetX, offsetY} = e;
                        let points = [];
                        let count = 100;
                        let pluck_index = (offsetX/canvas_jq.width()) * count;
                        for(var i=0; i<count; i++) {
                            if(i<=pluck_index) {
                                start_y = 0;
                                end_y = offsetY - string_y
                                points[i] = end_y*(i/pluck_index) / string_y;
                            } else {
                                start_y = offsetY - string_y;
                                end_y = 0;
                                points[i] = start_y*((count-i)/(count-pluck_index)) / string_y;
                            }

                        }

                        let freqs = stringFFT(points);
                        for(var wi=0; wi<waves.length; wi++) {
                            waves[wi].wave.amplitude = (freqs[waves[wi].wave.freq]) / 5
                        }
                        init()
                        start = Date.now();
                        playing = true;
                        frame()
                        

                        var AudioContext = window.AudioContext || window.webkitAudioContext || false; 

                        if(AudioContext) {
                            var audio_context = new AudioContext();
                            soundwave = new soundWave(audio_context, waves.map(wc => wc.wave));
                            soundwave.play();
                        }

                    }
                    plucking = false;
                })
                canvas_jq.on('mousemove', (e) => {
                    if(plucking) {
                        context.fillStyle = "rgba(255,255,255, 1)";
                        context.fillRect(0, 0, context.width, context.height);
                        let {offsetX, offsetY} = e;

                        context.beginPath();
                        context.moveTo(0, string_y);
                        context.lineTo(offsetX, offsetY);
                        context.lineTo(canvas_jq.width(), string_y);
                        context.stroke();

                        let points = [];
                        let count = 100;
                        let pluck_index = (offsetX/canvas_jq.width()) * count;
                        for(var i=0; i<count; i++) {
                            if(i<=pluck_index) {
                                start_y = 0;
                                end_y = offsetY - string_y
                                points[i] = start_y + end_y*(i/pluck_index);
                            } else {
                                start_y = offsetY - string_y;
                                end_y = 0;
                                points[i] = start_y*((count-i)/(count-pluck_index));
                            }

                            //context.fillStyle = "rgba(0, 0, 0, 1)";
                            //context.fillRect((i/count)*canvas_jq.width(), points[i]+string_y, 5, 5);
                        }
                    }
                })

                function stringFFT(points) {
                    let freqs = {};
                    for(var freq=110; freq<=880; freq+= 110) {
                        let resonance = 0;
                        for(var i=0; i<points.length; i++) {
                            var angle = 2 * Math.PI * (freq/220) * i / points.length;
                            resonance += points[i] * Math.sin(angle)
                        }
                        freqs[freq] = resonance;
                    }
                    return freqs;
                }

                
            });

        </script>
    </head>
    <body>
        <div class='container'>
            <div id='draw'> </div>
        </div>
    </body>
</html>

